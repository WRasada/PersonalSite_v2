require('es6');
var title = function(app){
  return function(title, options){
    var $title = title, $options = options;
    if(app.get('prefix')==null) app.set('prefix', '');
    if(app.get('suffix')==null) app.set('suffix', '');
    if(app.get('ps')==null) app.set('ps', ' | ');
    return function (req, res, next) {
      if($title){
        var _title = $title, title = $title, ps = app.get('ps');
        if($options){
          if($options.ps != null) ps = $options.ps;
          if($options.prefix != null){
            if($options.prefix === true) title = app.get('prefix')+ps+title;
            else if($options.prefix !== false) title = $options.prefix+ps+title;
          } else if(app.get('prefix')) title = app.get('prefix')+ps+title;
          if($options.suffix != null){
            if($options.suffix === true) title += ps+app.get('suffix');
            else if($options.suffix !== false) title += ps+$options.suffix;
          } else if(app.get('suffix')) title += ps+app.get('suffix');
        }else{
          if(app.get('prefix')) title = app.get('prefix')+ps+title;
          if(app.get('suffix')) title += ps+app.get('suffix');
        }
        var params = title.match(/\:(.+?)(\/|(?=\s|$))/g);
        if(params) params.forEach(function(e){
          var f = e.substr(1,e.length-1).replace(/\s+$/, '');
          if(f.endsWith('/')) f = f.substr(0, f.length-1);
          if(req.params[f]){
            title = title.replace(e, req.params[f]);
          }
        });
        res.locals.title = title;
      }
      next();
    }
  }
}; module.exports = title;
